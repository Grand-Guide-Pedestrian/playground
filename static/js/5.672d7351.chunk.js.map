{"version":3,"sources":["components/overlay/Overlay.tsx","components/overlay/index.ts","components/player/index.ts","components/player/Player.tsx","components/controls/ControlKey.tsx","components/controls/Controls.tsx","components/controls/index.ts","pages/GamePage.tsx","hooks/useWebSokets.tsx"],"names":["useStyles","makeStyles","overlay","position","top","left","right","bottom","background","overflow","Overlay","zIndex","className","style","Player","videoNode","player","this","flvjs","createPlayer","type","isLive","url","hasAudio","hasVideo","enableStashBuffer","stashInitialSize","LoggingControl","enableError","enableWarn","attachMediaElement","load","play","on","err","console","log","destroy","controls","ref","node","height","width","React","Component","ControlKey","id","onClick","Button","keys","Controls","onAction","dispatch","useAppDispatch","actionKey","useAppSelector","selectionActionKey","useCallback","keyCode","setActionKey","keyHandler","e","key","useEffect","window","addEventListener","removeEventListener","document","querySelector","click","map","Game","selectGameInfo","serverUrl","gameId","useState","status","setStatus","server","useRef","serverEventListener","event","serverErrorListener","error","reason","current","WebSocket","close","onGameInfoChange","data","send","useWebSockets","history","useHistory","onKeyPress","toUpperCase","replace"],"mappings":"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","file":"static/js/5.672d7351.chunk.js","sourcesContent":["import React from 'react';\nimport { makeStyles } from '@material-ui/core/styles';\n\nconst useStyles = makeStyles({\n    overlay: {\n        position: 'absolute',\n        top: 0,\n        left: 0,\n        right: 0,\n        bottom: 0,\n\n        background: 'transparent',\n\n        overflow: 'hidden',\n    },\n});\n\nconst Overlay: React.FC<{ zIndex: number }> = ({ zIndex }) => (\n    <div className={useStyles().overlay} style={{ zIndex: zIndex }}></div>\n);\n\nexport default Overlay;\n","import Overlay from './Overlay';\n\nexport default Overlay;","import Player from './Player';\n\nexport default Player;","import React from 'react';\nimport Overlay from '../overlay';\nimport flvjs from 'flv.js';\n\nclass Player extends React.Component {\n  private videoNode!: HTMLVideoElement\n  private player!: flvjs.Player\n\n  componentDidMount() {\n    this.player = flvjs.createPlayer(\n      {\n        type: 'flv',\n        isLive: true,\n        url: 'http://18.192.37.20:8080/live/livestream.flv',\n        hasAudio: true,\n        hasVideo: true,\n      },\n      {\n        enableStashBuffer: true,\n        stashInitialSize: 128,\n      }\n    )\n\n    flvjs.LoggingControl.enableError = false;\n    flvjs.LoggingControl.enableWarn = true;\n\n    this.player.attachMediaElement(this.videoNode);\n    this.player.load();\n    this.player.play(); // REQUIRES BROWSER PERMISSION!!!\n    this.player.on('error', (err) => {\n      console.log(err);\n    });\n  }\n\n  // destroy player on unmount\n  componentWillUnmount() {\n    this.player.destroy();\n  }\n\n  render() {\n    return (\n      <>\n        <video\n          controls={true}\n          ref={node => this.videoNode = node!}\n          height='100%'\n          width='100%'\n          style={{width: '100vw', height: '100vh'}}\n        />\n        <Overlay zIndex={1} />\n      </>\n    );\n  }\n}\n\nexport default Player;\n","import React from 'react';\nimport { KeyCode } from '../../types/key';\nimport { OnActionType } from './Controls';\nimport Button from '@material-ui/core/Button';\n\nexport interface ControlKeyData {\n    id: KeyCode;\n}\n\nconst ControlKey: React.FC<{ id: KeyCode; onClick: OnActionType; }> = ({ id, onClick }) => {\n\n    return (\n        <Button\n            id={id}\n            className='controls__key'\n            onClick={() => onClick(id, 'keydown')}\n        >\n            {id}\n        </Button>\n    );\n};\n\nexport default ControlKey;\n","import { useCallback, useEffect } from 'react';\nimport ControlKey, { ControlKeyData } from './ControlKey';\n\nimport { KeyCode, KeyType } from '../../types/key';\n\nimport './Controls.css';\nimport { useAppDispatch, useAppSelector } from '../../store/hooks';\nimport { selectionActionKey, setActionKey } from '../../store/slices/gameSlice';\n\nexport type OnActionType = (keyCode: KeyCode, type: KeyType) => void;\n\nconst keys: ControlKeyData[] = [{ id: 'w' }, { id: 'a' }, { id: 's' }, { id: 'd' }];\n\nconst Controls: React.FC<{ onAction: OnActionType }> = ({ onAction }) => {\n    const dispatch = useAppDispatch();\n    const actionKey = useAppSelector(selectionActionKey);\n\n    const onClick = useCallback(\n        (keyCode: KeyCode, type: KeyType) => {\n            onAction(keyCode, type);\n            dispatch(setActionKey());\n        },\n        [onAction, dispatch],\n    );\n\n    const keyHandler = useCallback(\n        (e: KeyboardEvent) => {\n            if (e.key === 'w' || e.key === 'a' || e.key === 's' || e.key === 'd') {\n                dispatch(setActionKey(e.key));\n            } else {\n                return;\n            }\n        },\n        [dispatch],\n    );\n\n    useEffect(() => {\n        window.addEventListener('keydown', keyHandler);\n        window.addEventListener('keyup', keyHandler);\n\n        return () => {\n            window.removeEventListener('keydown', keyHandler);\n            window.removeEventListener('keyup', keyHandler);\n        };\n    }, [keyHandler]);\n\n    useEffect(() => {\n        if (actionKey) {\n            (document.querySelector(`#${actionKey} > span.MuiTouchRipple-root`) as HTMLButtonElement)?.click();\n        }\n    }, [actionKey]);\n\n    return (\n        <section className=\"controls\">\n            {keys.map((key) => (\n                <ControlKey key={key.id} id={key.id} onClick={onClick} />\n            ))}\n        </section>\n    );\n};\n\nexport default Controls;\n","import Controls from './Controls';\n\nexport default Controls;\n","import Player from '../components/player';\nimport Controls from '../components/controls';\n\nimport { useWebSockets } from '../hooks/useWebSokets';\nimport { useCallback } from 'react';\nimport { OnActionType } from '../components/controls/Controls';\nimport { KeyCode, KeyType } from '../types/key';\nimport { useEffect } from 'react';\nimport { useHistory } from 'react-router';\nimport { useAppDispatch, useAppSelector } from '../store/hooks';\nimport { onGameInfoChange, selectGameInfo } from '../store/slices/gameSlice';\n\nfunction Game() {\n    const { serverUrl, gameId } = useAppSelector(selectGameInfo);\n    const { status, onAction } = useWebSockets({ serverUrl, gameId });\n    const history = useHistory();\n    const dispatch = useAppDispatch();\n\n    const onKeyPress: OnActionType = useCallback(\n        (keyCode: KeyCode, type: KeyType) => {\n            onAction(`${keyCode.toUpperCase()}_${type === 'keyup' ? 'UP' : 'DOWN'}`);\n        },\n        [onAction],\n    );\n\n    useEffect(() => {\n        if (status === 'close' || status === 'error') {\n            dispatch(onGameInfoChange({}));\n            history.replace('/login');\n        }\n    }, [status, history, dispatch, gameId, serverUrl]);\n\n    return (\n        <div className=\"game\">\n            <Player />\n            <Controls onAction={onKeyPress} />\n        </div>\n    );\n}\n\nexport default Game;\n","import { useRef } from 'react';\nimport { useCallback } from 'react';\nimport { useEffect } from 'react';\nimport { useState } from 'react';\nimport { useAppDispatch } from '../store/hooks';\nimport { error } from '../store/slices/commonSlice';\nimport { onGameInfoChange } from '../store/slices/gameSlice';\n\nconst url = (url: string, id: number) => `${url}/game/${id}/player`;\n\nexport type ServerEvent = 'message' | 'open' | 'close' | 'error';\nexport type Props = {\n    gameId?: number;\n    serverUrl?: string;\n};\n\nexport const useWebSockets = ({ serverUrl, gameId }: Props) => {\n    const [status, setStatus] = useState<ServerEvent | undefined>();\n    const server = useRef<WebSocket>();\n    const dispatch = useAppDispatch();\n\n    useEffect(() => {\n        const serverEventListener = (event: Event) => {\n            setStatus(event.type as ServerEvent);\n        };\n        const serverErrorListener = (event: CloseEvent) => {\n            dispatch(error(event.reason));\n            setStatus(event.type as ServerEvent);\n        };\n        if (!status && gameId && serverUrl) {\n            console.log(`Trying to establish connection with server with gameId ${gameId}`);\n            console.log('rerender websocket effect', server.current, status, gameId, serverUrl);\n            server.current = new WebSocket(url(serverUrl, gameId));\n            server.current.addEventListener('message', serverEventListener);\n            server.current.addEventListener('open', serverEventListener);\n            server.current.addEventListener('close', serverErrorListener);\n            server.current.addEventListener('error', serverEventListener);\n        }\n        return () => {\n            if (!!server.current && (status === 'error' || status === 'close')) {\n                console.log(`Closing connection with server`);\n                server.current.removeEventListener('message', serverEventListener);\n                server.current.removeEventListener('open', serverEventListener);\n                server.current.removeEventListener('error', serverEventListener);\n                server.current.removeEventListener('close', serverErrorListener);\n                server.current.close();\n                dispatch(onGameInfoChange({}));\n            }\n        };\n    }, [status, gameId, serverUrl, dispatch]);\n\n    useEffect(() => {\n        //close connection on component destroy\n        return () => server.current?.close();\n    }, []);\n\n    const onAction = useCallback(\n        (data: string) => {\n            if (!!server.current && status === 'open') {\n                server.current.send(data);\n            }\n        },\n        [status],\n    );\n\n    return { status, onAction };\n};\n"],"sourceRoot":""}